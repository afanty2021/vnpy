# 辅助功能

<cite>
**本文档引用的文件**
- [rpc_service.md](file://docs/community/app/rpc_service.md)
- [web_trader.md](file://docs/community/app/web_trader.md)
- [excel_rtd.md](file://docs/community/app/excel_rtd.md)
- [chart_wizard.md](file://docs/community/app/chart_wizard.md)
- [client.py](file://vnpy/rpc/client.py)
- [server.py](file://vnpy/rpc/server.py)
- [common.py](file://vnpy/rpc/common.py)
- [widget.py](file://vnpy/chart/widget.py)
</cite>

## 目录
1. [RPC服务](#rpc服务)
2. [WebTrader模块](#webtrader模块)
3. [Excel RTD服务](#excel-rtd服务)
4. [Chart Wizard](#chart-wizard)

## RPC服务

RPC服务模块基于ZeroMQ实现远程过程调用功能，支持VeighNa系统的分布式部署架构。该模块通过将VeighNa Trader进程转化为RPC服务器，对外提供交易路由、行情数据推送、持仓资金查询等核心功能，有效解决了Python全局解释器锁（GIL）导致的单进程性能瓶颈问题。

RPC服务采用客户端-服务器架构，包含两个核心组件：RpcServer和RpcClient。服务器端通过`RpcServer`类实现，负责监听客户端请求并执行相应功能；客户端通过`RpcClient`类实现，用于调用服务器端的远程函数。通信协议基于ZeroMQ的REQ/REP（请求-响应）模式和PUB/SUB（发布-订阅）模式，分别处理主动请求和被动数据推送。

服务器端启动时，会绑定两个地址：请求响应地址用于接收客户端的请求（如行情订阅、委托下单、撤单等），事件广播地址用于向所有已连接的客户端推送实时数据（如行情、委托、成交等）。支持TCP和IPC两种通信协议，其中TCP协议适用于跨网络通信，IPC协议仅限Linux系统本机通信，具有更低的通信延迟。

在异常处理机制方面，RPC服务实现了完善的错误传播机制。服务器端执行函数时若发生异常，会捕获异常信息并通过pickle序列化后返回给客户端；客户端接收到响应后，会反序列化并抛出相应的`RemoteException`异常。同时，系统还实现了心跳检测机制，通过`HEARTBEAT_TOPIC`主题定期发送心跳包，当客户端在`HEARTBEAT_TOLERANCE`（默认30秒）内未收到心跳时，会触发`on_disconnected`回调，提示连接异常。

**RPC服务的应用场景包括**：对于运行大量策略的用户，只需一条行情和交易通道即可支持多个客户端进程同时交易，各客户端策略独立运行互不影响；对于中小型投资机构，可在服务端统一配置交易接口并集成风险管理模块，实现多交易员共享统一交易通道的轻量级资管系统。

**Section sources**
- [rpc_service.md](file://docs/community/app/rpc_service.md)
- [client.py](file://vnpy/rpc/client.py)
- [server.py](file://vnpy/rpc/server.py)
- [common.py](file://vnpy/rpc/common.py)

## WebTrader模块

WebTrader模块为VeighNa系统提供了Web应用后端服务，使用户能够通过浏览器而非PyQt桌面端来管理和运行量化策略交易。该模块采用FastAPI作为后端服务器框架，构建了双进程架构：策略交易进程负责所有交易功能的执行，并启动`RpcServer`供Web服务进程调用；Web服务进程运行FastAPI，负责对外提供Web访问服务，并启动`RpcClient`调用策略交易进程的功能。

系统实现了双向通信模式，支持主动请求调用和被动数据推送。主动请求调用流程为：浏览器发起REST API调用到Web服务进程，Web服务进程将其转换为RPC请求（REQ/REP模式）发送给策略交易进程，策略交易进程处理后返回结果，最终由Web服务进程返回给浏览器。被动数据推送流程为：浏览器与Web服务进程建立WebSocket连接，策略交易进程通过RPC推送（PUB/SUB模式）将数据发送给Web服务进程，Web服务进程再通过WebSocket API实时推送给浏览器，数据格式为JSON。

模块提供了完整的REST API接口和WebSocket接口规范，支持多种交易操作。用户可通过POST请求订阅行情、查询合约、账户、持仓、委托、成交等数据；通过POST请求发送委托指令，DELETE请求撤销委托。接口文档可通过访问`http://127.0.0.1:8000/docs`查看，系统自动生成交互式API文档。安全方面，采用基于JWT的令牌认证机制，用户需先通过用户名密码获取访问令牌，后续所有请求均需在Authorization头中携带该令牌。

**Section sources**
- [web_trader.md](file://docs/community/app/web_trader.md)
- [client.py](file://vnpy/rpc/client.py)
- [server.py](file://vnpy/rpc/server.py)

## Excel RTD服务

Excel RTD服务模块实现了在Excel中实时获取VeighNa程序内任意数据信息的功能。RTD（RealTimeData）是微软为金融行业实时数据需求设计的Excel数据对接方案，该模块依赖于商业软件PyXLL（www.pyxll.com），需要购买许可证才能使用（提供30天免费试用）。

要使用该功能，首先需要安装PyXLL插件。安装完成后，将`vnpy_excelrtd`模块下的`vnpy_rtd.py`文件复制到PyXLL安装目录的examples文件夹中。在VeighNa系统中加载ExcelRtd应用模块后，即可在Excel表格中通过PyXLL调用`rtd_tick_data`等函数获取实时数据。

该模块支持多种高级应用场景。用户可以在Excel中创建期货市场报价跟踪表，实时监控多个合约的买卖盘口、最新价等信息；构建市场深度行情跟踪表，展示不同价位的挂单量分布；实现价差监控功能，计算并监控两个相关合约之间的价差变化。通过Excel强大的数据处理和可视化能力，用户可以将VeighNa的实时数据与复杂的分析模型相结合，满足个性化的交易分析需求。

**Section sources**
- [excel_rtd.md](file://docs/community/app/excel_rtd.md)

## Chart Wizard

Chart Wizard模块为VeighNa系统提供了实时K线图表展示功能，用户可通过其UI界面查看实时和历史K线行情。目前支持显示1分钟级别的K线数据，实时K线（最新的一根K线）采用Tick级刷新，确保数据的实时性。

图表功能基于`vnpy/chart`模块实现，核心组件为`ChartWidget`控件。每个合约的图表分为上下两个子图区域：上方为K线图，显示开高低收价格；下方为成交量图，以柱状图形式展示交易量。系统支持多种图表类型，包括K线图、成交量图、技术指标图（如MA、MACD、RSI等）、散点图和线图，并支持多坐标轴显示，主坐标轴显示价格，副坐标轴可显示成交量或指标值。

在性能优化方面，系统实现了多项关键技术：通过数据采样减少大量历史数据的渲染负担；采用增量更新机制避免全图重绘；实施视口裁剪只绘制可见部分。交互功能丰富，支持十字光标跟踪，可精确定位并显示特定时间点的OHLCV数据；支持鼠标拖拽平移和滚轮缩放操作；提供数据提示（Tooltip）和图例显示功能。

**Section sources**
- [chart_wizard.md](file://docs/community/app/chart_wizard.md)
- [widget.py](file://vnpy/chart/widget.py)