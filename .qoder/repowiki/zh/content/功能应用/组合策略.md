# 组合策略

<cite>
**本文档引用的文件**
- [portfolio_strategy.md](file://docs/community/app/portfolio_strategy.md)
- [elite_portfoliostrategy.md](file://docs/elite/strategy/elite_portfoliostrategy.md)
- [backtesting_demo.ipynb](file://examples/portfolio_backtesting/backtesting_demo.ipynb)
</cite>

## 目录
1. [引言](#引言)
2. [多资产协同管理能力](#多资产协同管理能力)
3. [组合权重分配与风险预算控制](#组合权重分配与风险预算控制)
4. [再平衡触发机制](#再平衡触发机制)
5. [事件总线协调机制](#事件总线协调机制)
6. [资产配置模型配置](#资产配置模型配置)
7. [风险阈值设置与头寸监控](#风险阈值设置与头寸监控)
8. [多策略组合回测流程](#多策略组合回测流程)
9. [结论](#结论)

## 引言

组合策略应用（PortfolioStrategyApp）是vn.py框架中用于多合约组合策略实盘交易的功能模块，支持股票、期货、期权等多品种联合建模。该模块通过UI界面提供策略初始化、启动、停止、参数编辑和移除等操作，为用户提供便捷的策略管理功能。组合策略模块针对多标的投资组合类量化策略，追求将投资组合的持仓调整到目标状态，而不过多关注底层的委托交易细节。

**Section sources**
- [portfolio_strategy.md](file://docs/community/app/portfolio_strategy.md#L1-L10)

## 多资产协同管理能力

组合策略应用支持多合约组合策略实盘交易，能够同时管理多个资产的交易策略。用户可以基于编写好的组合策略模板（类）创建不同的策略实例（对象），并通过UI界面进行管理。策略实例的创建需要配置实例名称、合约品种和相关参数，其中合约品种格式为vt_symbol（合约代码 + 交易所名称），多个合约名用逗号隔开。

组合策略模块通过on_bars回调函数一次性接收所有合约的K线数据，而不是像CTA策略模块那样通过on_bar函数逐个接收。这种设计确保了在多资产协同管理中，所有合约的K线数据在同一时间点上同步更新，避免了因数据接收顺序不同而导致的逻辑错误。

**Section sources**
- [portfolio_strategy.md](file://docs/community/app/portfolio_strategy.md#L63-L65)
- [portfolio_strategy.md](file://docs/community/app/portfolio_strategy.md#L461-L464)

## 组合权重分配与风险预算控制

组合策略应用通过设定目标仓位（set_target）来实现组合权重分配。在策略中调用set_target函数可以设定特定合约的目标仓位，目标仓位是一种持续性的状态，设置后在后续时间会持续保持，直到被再次修改。策略的目标仓位状态会在sync_data时自动持久化到硬盘文件，并在策略重启后恢复。

风险预算控制通过参数设置和策略逻辑实现。用户在创建策略实例时可以配置相关参数，如布林带窗口、布林带偏差、CCI窗口、ATR窗口等，这些参数直接影响策略的风险暴露。策略通过计算技术指标（如布林带、CCI、ATR等）来判断市场状态，并根据市场状态调整目标仓位，从而实现风险预算控制。

**Section sources**
- [portfolio_strategy.md](file://docs/community/app/portfolio_strategy.md#L736-L745)
- [portfolio_strategy.md](file://docs/community/app/portfolio_strategy.md#L752-L754)

## 再平衡触发机制

再平衡触发机制通过rebalance_portfolio函数实现。在策略中调用rebalance_portfolio函数可以基于设定的特定合约目标仓位执行调仓交易。只有当前bars字典中有K线切片的合约才会参与本次调仓交易的执行，从而保证非交易时段（没有行情推送）的合约不会错误发出委托。

在TrendFollowingStrategy策略示例中，on_bars函数首先更新K线计算RSI数值，然后根据ATR指标和RSI指标计算结果在通道突破点设定目标仓位，最后调用rebalance_portfolio函数执行调仓交易。这种机制确保了策略在市场状态变化时能够及时调整持仓，实现动态再平衡。

**Section sources**
- [portfolio_strategy.md](file://docs/community/app/portfolio_strategy.md#L756-L765)
- [portfolio_strategy.md](file://docs/community/app/portfolio_strategy.md#L778-L848)

## 事件总线协调机制

组合策略应用通过事件总线协调多个子策略的信号生成与执行调度。事件总线负责接收和分发各种事件，如K线数据更新、委托状态更新等。当策略收到最新的K线数据时，on_bars函数会被调用，策略根据K线数据计算技术指标并生成交易信号。

在信号生成后，策略通过调用buy/sell/short/cover等交易请求类函数向策略引擎发送交易信号。策略引擎接收到交易信号后，通过事件总线将委托请求发送到底层交易接口。这种设计实现了信号生成与执行调度的解耦，提高了系统的灵活性和可扩展性。

**Section sources**
- [portfolio_strategy.md](file://docs/community/app/portfolio_strategy.md#L455-L464)
- [portfolio_strategy.md](file://docs/community/app/portfolio_strategy.md#L572-L584)

## 资产配置模型配置

用户可以通过UI界面配置资产配置模型。在添加策略时，用户需要选择要交易的策略类，并配置相关参数。参数配置包括实例名称、合约品种和策略参数。实例名称不能重名，合约品种格式为vt_symbol，策略参数包括布林带窗口、布林带偏差、CCI窗口、ATR窗口等。

配置完成后，策略实例的配置信息会被保存到.vntrader文件夹下的portfolio_strategy_setting.json文件中。用户可以通过UI界面的【编辑】按钮修改策略参数，修改后的参数会立即更新到参数表格中，并保存到json文件中。

**Section sources**
- [portfolio_strategy.md](file://docs/community/app/portfolio_strategy.md#L61-L88)
- [portfolio_strategy.md](file://docs/community/app/portfolio_strategy.md#L147-L156)

## 风险阈值设置与头寸监控

风险阈值设置通过策略参数实现。用户在创建策略实例时可以设置各种风险参数，如止损乘数、固定大小、价格加成等。这些参数直接影响策略的风险暴露和交易行为。

头寸监控通过UI界面实现。策略监控组件顶部显示策略实例名、策略类名和策略作者名，顶部按钮用于控制和管理策略实例。第一行表格显示策略内部的参数信息，第二行表格显示策略运行过程中的变量信息。【inited】字段表示策略的初始化状态，【trading】字段表示策略是否能够开始交易。

用户可以通过调用put_event函数跟踪策略变量的状态变化，通过调用write_log函数输出个性化日志。这些功能帮助用户实时监控策略的运行状态和风险暴露。

**Section sources**
- [portfolio_strategy.md](file://docs/community/app/portfolio_strategy.md#L93-L96)
- [portfolio_strategy.md](file://docs/community/app/portfolio_strategy.md#L180-L187)

## 多策略组合回测流程

多策略组合回测流程通过BacktestingEngine实现。在backtesting_demo.ipynb示例中，首先导入BacktestingEngine、Interval和OptimizationSetting，然后创建BacktestingEngine实例并设置回测参数，包括合约品种、数据频率、回测时间范围、费率、滑点、合约乘数、最小价格变动和初始资金。

设置完回测参数后，通过add_strategy函数添加策略实例和策略设置。调用load_data函数加载历史数据，run_backtesting函数运行回测，calculate_result函数计算回测结果，calculate_statistics函数计算统计指标，show_chart函数显示回测图表。

收益归因分析通过分析各合约的收益贡献实现，夏普比率优化通过参数优化实现，最大回撤控制通过策略逻辑和风险参数设置实现。用户可以通过穷举算法或遗传算法进行参数优化，选择最优的参数组合。

**Section sources**
- [backtesting_demo.ipynb](file://examples/portfolio_backtesting/backtesting_demo.ipynb#L1-L54)
- [backtesting_demo.ipynb](file://examples/portfolio_backtesting/backtesting_demo.ipynb#L55-L68)

## 结论

组合策略应用（PortfolioStrategyApp）提供了强大的多资产协同管理能力，支持股票、期货、期权等多品种联合建模。通过设定目标仓位实现组合权重分配，通过参数设置和策略逻辑实现风险预算控制，通过rebalance_portfolio函数实现再平衡触发。事件总线协调多个子策略的信号生成与执行调度，确保系统的灵活性和可扩展性。

用户可以通过UI界面配置资产配置模型，设置风险阈值，并监控整体头寸暴露。多策略组合回测流程通过BacktestingEngine实现，支持收益归因分析、夏普比率优化和最大回撤控制。组合策略应用为用户提供了一个功能强大、易于使用的多资产量化交易解决方案。